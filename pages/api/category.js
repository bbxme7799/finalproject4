import dbConnect from "../../utils/db";
import Service from "../../models/service";

export default async function handler(req, res) {
  if (req.method !== "GET") {
    return res.status(405).json({ message: "Method not allowed" });
  }

  try {
    // ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MongoDB
    await dbConnect();

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Service
    const services = await Service.find({});

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á
    const filteredServices = services.filter((service) => service.category);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ set ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö category ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
    const uniqueCategories = new Set();

    // ‡∏ß‡∏ô loop ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥ category ‡∏à‡∏≤‡∏Å filteredServices ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô uniqueCategories
    filteredServices.forEach((service) => {
      uniqueCategories.add(service.category);
    });

    // ‡πÅ‡∏õ‡∏•‡∏á Set ‡πÄ‡∏õ‡πá‡∏ô Array
    const uniqueCategoriesArray = Array.from(uniqueCategories);
    console.log(
      "üöÄ ~ file: category.js:30 ~ handler ~ uniqueCategoriesArray:",
      uniqueCategoriesArray
    );

    return res.status(200).json({ category: uniqueCategoriesArray });
  } catch (error) {
    return res.status(500).json({ error: "Could not fetch categories" });
  }
}
